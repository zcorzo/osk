<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Hex Keyboard – Prototype</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    background: #111;
  }

  /* App layout: vertical stack, bar on top, keyboard fills the rest */
  #app {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Autocomplete bar at the top */
  #autocomplete-bar {
    flex: 0 0 44px;               /* fixed vertical height */
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    box-sizing: border-box;
    background: #181818;
    border-bottom: 1px solid #333;
  }

  .suggestion {
    flex: 1 1 0;
    min-width: 0;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #444;
    background: #252525;
    color: #fff;
    font-size: 14px;
    font-family: system-ui, Segoe UI, sans-serif;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
  }

  .suggestion.primary {
    background: #303030;
    border-color: #666;
    font-weight: 600;
  }

  .suggestion.secondary {
    opacity: 0.9;
  }

  .suggestion.selected {
    border-color: #8ab4ff;
    box-shadow: 0 0 0 1px #8ab4ff inset;
  }

  .suggestion:hover {
    background: #333;
  }

  /* Keyboard area fills the rest */
  #keyboard-container {
    flex: 1 1 auto;
    min-height: 0; /* so SVG can shrink */
  }

  svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  .hex {
    fill:#222;
    stroke:#0a0a0a;
    stroke-width:2.2;
    stroke-linejoin:round;
    vector-effect:non-scaling-stroke;
  }
  .hex:hover {
    fill:#2f2f2f;
    cursor:pointer;
  }

  .ctrl { fill:#262626; }
  .arrow { fill:#1f1f1f; }
  .mod   { fill:#1e1e1e; }

  text {
    fill:#fff;
    font-family: system-ui, Segoe UI Symbol, sans-serif;
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
    user-select: none;
  }
  .main  { font-size: 14px; font-weight: 700; }
  .shift { font-size: 9px; font-weight: 600; opacity: 0.9; }

  .pressed .hex {
    fill:#3f3f3f;
  }
  .latched .hex {
    fill:#3f3f3f;
  }

  
</style>
</head>
<body>
<div id="app">
  <!-- Autocomplete bar at the top -->
  <div id="autocomplete-bar">
    <button class="suggestion primary" data-index="0">Suggestion 1</button>
    <button class="suggestion secondary" data-index="1">Suggestion 2</button>
    <button class="suggestion secondary" data-index="2">Suggestion 3</button>
  </div>

  <!-- Keyboard area -->
  <div id="keyboard-container">
    <!-- Your existing SVG layout -->
    <svg xmlns="http://www.w3.org/2000/svg"
         viewBox="-90.0 -90.0 630.0 517.7"
         shape-rendering="geometricPrecision">
      <defs>
        <polygon id="HEX" points="30.250,0 15.125,26.197 -15.125,26.197 -30.250,0 -15.125,-26.197 15.125,-26.197" />
      </defs>

      <g transform="translate(0.000,0.000)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,51.962)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,103.923)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,155.885)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,207.846)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,259.808)">
        <use href="#HEX" class="hex" />
      </g>
      <g transform="translate(0.000,311.769)">
        <use href="#HEX" class="hex" />
      </g>

      <g transform="translate(45.000,25.981)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">!</text>
        <text class="main" y="6">1</text>
      </g>
      <g transform="translate(45.000,77.942)">
        <use href="#HEX" class="hex" />
        <text class="main">ESC</text>
      </g>
      <g transform="translate(45.000,129.904)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">HOME</text>
      </g>
      <g transform="translate(45.000,181.865)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">END</text>
      </g>
      <g transform="translate(45.000,233.827)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">INS</text>
      </g>
      <g transform="translate(45.000,285.788)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">PRTSC</text>
      </g>
      <g transform="translate(45.000,337.750)">
        <use href="#HEX" class="hex mod" />
        <text class="main">FN</text>
      </g>

      <g transform="translate(90.000,0.000)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">@</text>
        <text class="main" y="6">2</text>
      </g>
      <g transform="translate(90.000,51.962)">
        <use href="#HEX" class="hex" />
        <text class="main">TAB</text>
      </g>
      <g transform="translate(90.000,103.923)">
        <use href="#HEX" class="hex" />
        <text class="main">CAPS</text>
      </g>
      <g transform="translate(90.000,155.885)">
        <use href="#HEX" class="hex" />
        <text class="main">B</text>
      </g>
      <g transform="translate(90.000,207.846)">
        <use href="#HEX" class="hex" />
        <text class="main">F</text>
      </g>
      <g transform="translate(90.000,259.808)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">`~</text>
      </g>
      <g transform="translate(90.000,311.769)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">OPT</text>
      </g>

      <g transform="translate(135.000,25.981)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">#</text>
        <text class="main" y="6">3</text>
      </g>
      <g transform="translate(135.000,77.942)">
        <use href="#HEX" class="hex" />
        <text class="main">X</text>
      </g>
      <g transform="translate(135.000,129.904)">
        <use href="#HEX" class="hex" />
        <text class="main">C</text>
      </g>
      <g transform="translate(135.000,181.865)">
        <use href="#HEX" class="hex" />
        <text class="main">H</text>
      </g>
      <g transform="translate(135.000,233.827)">
        <use href="#HEX" class="hex" />
        <text class="main">U</text>
      </g>
      <g transform="translate(135.000,285.788)">
        <use href="#HEX" class="hex" />
        <text class="main">K</text>
      </g>
      <g transform="translate(135.000,337.750)">
        <use href="#HEX" class="hex mod" />
        <text class="main">CTRL</text>
      </g>

      <g transform="translate(180.000,0.000)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">$</text>
        <text class="main" y="6">4</text>
      </g>
      <g transform="translate(180.000,51.962)">
        <use href="#HEX" class="hex" />
        <text class="main">Y</text>
      </g>
      <g transform="translate(180.000,103.923)">
        <use href="#HEX" class="hex" />
        <text class="main">R</text>
      </g>
      <g transform="translate(180.000,155.885)">
        <use href="#HEX" class="hex" />
        <text class="main">E</text>
      </g>
      <g transform="translate(180.000,207.846)">
        <use href="#HEX" class="hex" />
        <text class="main">T</text>
      </g>
      <g transform="translate(180.000,259.808)">
        <use href="#HEX" class="hex" />
        <text class="main">O</text>
      </g>
      <g transform="translate(180.000,311.769)">
        <use href="#HEX" class="hex" />
        <text class="main">Z</text>
      </g>

      <g transform="translate(225.000,25.981)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">%</text>
        <text class="main" y="6">5</text>
      </g>
      <g transform="translate(225.000,77.942)">
        <use href="#HEX" class="hex" />
        <text class="main">W</text>
      </g>
      <g transform="translate(225.000,129.904)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">SHIFT</text>
      </g>
      <g transform="translate(225.000,181.865)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main" style="opacity:0">SPC</text>
      </g>
      <g transform="translate(225.000,233.827)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">ENT</text>
      </g>
      <g transform="translate(225.000,285.788)">
        <use href="#HEX" class="hex" />
        <text class="main">M</text>
      </g>
      <g transform="translate(225.000,337.750)">
        <use href="#HEX" class="hex mod" />
        <text class="main">ALT</text>
      </g>

      <g transform="translate(270.000,0.000)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">^</text>
        <text class="main" y="6">6</text>
      </g>
      <g transform="translate(270.000,51.962)">
        <use href="#HEX" class="hex" />
        <text class="main">P</text>
      </g>
      <g transform="translate(270.000,103.923)">
        <use href="#HEX" class="hex" />
        <text class="main">S</text>
      </g>
      <g transform="translate(270.000,155.885)">
        <use href="#HEX" class="hex" />
        <text class="main">A</text>
      </g>
      <g transform="translate(270.000,207.846)">
        <use href="#HEX" class="hex" />
        <text class="main">I</text>
      </g>
      <g transform="translate(270.000,259.808)">
        <use href="#HEX" class="hex" />
        <text class="main">L</text>
      </g>
      <g transform="translate(270.000,311.769)">
        <use href="#HEX" class="hex" />
        <text class="main">V</text>
      </g>

      <g transform="translate(315.000,25.981)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">&amp;</text>
        <text class="main" y="6">7</text>
      </g>
      <g transform="translate(315.000,77.942)">
        <use href="#HEX" class="hex" />
        <text class="main">J</text>
      </g>
      <g transform="translate(315.000,129.904)">
        <use href="#HEX" class="hex" />
        <text class="main">D</text>
      </g>
      <g transform="translate(315.000,181.865)">
        <use href="#HEX" class="hex" />
        <text class="main">N</text>
      </g>
      <g transform="translate(315.000,233.827)">
        <use href="#HEX" class="hex" />
        <text class="main">G</text>
      </g>
      <g transform="translate(315.000,285.788)">
        <use href="#HEX" class="hex" />
        <text class="main">Q</text>
      </g>
      <g transform="translate(315.000,337.750)">
        <use href="#HEX" class="hex mod" />
        <text class="main">⊞</text>
      </g>

      <g transform="translate(360.000,0.000)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">*</text>
        <text class="main" y="6">8</text>
      </g>
      <g transform="translate(360.000,51.962)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">—</text>
        <text class="main" y="6">–</text>
      </g>
      <g transform="translate(360.000,103.923)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">{</text>
        <text class="main" y="6">[</text>
      </g>
      <g transform="translate(360.000,155.885)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">&lt;</text>
        <text class="main" y="6">,</text>
      </g>
      <g transform="translate(360.000,207.846)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">&gt;</text>
        <text class="main" y="6">.</text>
      </g>
      <g transform="translate(360.000,259.808)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">:</text>
        <text class="main" y="6">;</text>
      </g>
      <g transform="translate(360.000,311.769)">
        <use href="#HEX" class="hex arrow" />
        <text class="main">←</text>
      </g>

      <g transform="translate(405.000,25.981)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">(</text>
        <text class="main" y="6">9</text>
      </g>
      <g transform="translate(405.000,77.942)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10">=</text>
        <text class="main" y="6">+</text>
      </g>
      <g transform="translate(405.000,129.904)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">}</text>
        <text class="main" y="6">]</text>
      </g>
      <g transform="translate(405.000,181.865)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">|</text>
        <text class="main" y="6">\</text>
      </g>
      <g transform="translate(405.000,233.827)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">"</text>
        <text class="main" y="6">'</text>
      </g>
      <g transform="translate(405.000,285.788)">
        <use href="#HEX" class="hex arrow" />
        <text class="main">↑</text>
      </g>
      <g transform="translate(405.000,337.750)">
        <use href="#HEX" class="hex arrow" />
        <text class="main">↓</text>
      </g>

      <g transform="translate(450.000,0.000)">
        <use href="#HEX" class="hex ctrl" />
        <text class="shift" y="-10)">)</text>
        <text class="main" y="6">0</text>
      </g>
      <g transform="translate(450.000,51.962)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">⌫</text>
      </g>
      <g transform="translate(450.000,103.923)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">DEL</text>
      </g>
      <g transform="translate(450.000,155.885)">
        <use href="#HEX" class="hex" />
        <text class="shift" y="-10">?</text>
        <text class="main" y="6">/</text>
      </g>
      <g transform="translate(450.000,207.846)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">PGUP</text>
      </g>
      <g transform="translate(450.000,259.808)">
        <use href="#HEX" class="hex ctrl" />
        <text class="main">PGDN</text>
      </g>
      <g transform="translate(450.000,311.769)">
        <use href="#HEX" class="hex arrow" />
        <text class="main">→</text>
      </g>
    </svg>
  </div>
</div>

<script>
  // Map text labels in the SVG to logical key names.
  const keyMap = {
    // Navigation / control
    'ENT': 'Enter',
    'ESC': 'Escape',
    'DEL': 'Delete',
    'INS': 'Insert',
    'PRTSC': 'PrintScreen',
    'PGUP': 'PageUp',
    'PGDN': 'PageDown',
    'HOME': 'Home',
    'END': 'End',
    'CAPS': 'CapsLock',
    'TAB': 'Tab',
    'SPC': 'Space',

    // Modifiers
    'SHIFT': 'Shift',
    'CTRL': 'Control',
    'ALT': 'Alt',
    'OPT': 'Alt',
    'FN': null,

    // Windows key
    '⊞': 'Meta',

    // Backspace
    '⌫': 'Backspace',

    // Arrows
    '←': 'ArrowLeft',
    '→': 'ArrowRight',
    '↑': 'ArrowUp',
    '↓': 'ArrowDown',

    // Punctuation / special remaps
    '`~': '`',
    '–': '-',
  };

  // Sticky modifiers (one-shot). Note: Meta (Windows) is NOT sticky; it sends immediately.
  const MODIFIER_KEYS = new Set(['Shift', 'Control', 'Alt']);
  const activeModifiers = new Set();

  // Tiny word list for prototype autocomplete.
  const WORD_LIST = [
    'example', 'keyboard', 'layout',
    'hello', 'help', 'hex', 'home',
    'test', 'text', 'type',
    'control', 'shift', 'space',
    'window', 'windows', 'word',
    'quick', 'brown', 'fox', 'jumped', 'over', 'lazy', 'dog'
  ];

  let currentWord = '';
  let currentSuggestions = [];
  let selectedSuggestionIndex = 0;

  function logicalFromLabel(label) {
    if (Object.prototype.hasOwnProperty.call(keyMap, label)) {
      return keyMap[label];
    }
    return label;
  }

  function computeSuggestions(prefix) {
    const p = (prefix || '').toLowerCase();
    if (!p) {
      return WORD_LIST.slice(0, 3);
    }

    const matches = [];
    for (const w of WORD_LIST) {
      if (w.startsWith(p)) {
        matches.push(w);
      }
      if (matches.length >= 3) {
        break;
      }
    }
    return matches;
  }

  function renderSuggestions() {
    const buttons = document.querySelectorAll('#autocomplete-bar .suggestion');

    for (let i = 0; i < buttons.length; i++) {
      const btn = buttons[i];
      const word = currentSuggestions[i] || '';

      btn.textContent = word || '\u00A0';
      btn.disabled = !word;

      btn.classList.toggle('selected', Boolean(word) && i === selectedSuggestionIndex);
    }
  }

  function updateSuggestions() {
    currentSuggestions = computeSuggestions(currentWord);
    if (selectedSuggestionIndex >= currentSuggestions.length) {
      selectedSuggestionIndex = 0;
    }
    renderSuggestions();
  }

  function sendKey(logical, modifiers = []) {
    if (window.pywebview && window.pywebview.api && window.pywebview.api.send_key) {
      window.pywebview.api.send_key({ key: logical, modifiers });
      return;
    }

    // Browser-only fallback
    console.log('sendKey:', logical, modifiers);
  }

  function sendText(text) {
    if (!text) return;

    if (window.pywebview && window.pywebview.api && window.pywebview.api.send_text) {
      window.pywebview.api.send_text(text);
      return;
    }

    for (const ch of text) {
      if (ch === ' ') {
        sendKey('Space', []);
      } else {
        sendKey(ch, []);
      }
    }
  }

  function acceptSuggestionForCurrentWord() {
    const suggestion = currentSuggestions[selectedSuggestionIndex] || '';
    const prefix = (currentWord || '').toLowerCase();

    if (!suggestion || !prefix) {
      return false;
    }

    if (!suggestion.startsWith(prefix) || suggestion === prefix) {
      return false;
    }

    const remainder = suggestion.slice(prefix.length);
    sendText(remainder + ' ');
    currentWord = '';
    updateSuggestions();
    return true;
  }

  function setupKeyboard() {
    const svg = document.querySelector('svg');
    if (!svg) return;

    const groups = svg.querySelectorAll('g');

    groups.forEach(g => {
      const mainText = g.querySelector('text.main');
      if (!mainText) return;

      const label = (mainText.textContent || '').trim();
      if (!label) return;

      const logical = logicalFromLabel(label);

      g.classList.add('kb-key');
      g.dataset.label = label;
      g.dataset.logical = logical || '';

      g.addEventListener('mousedown', () => {
        g.classList.add('pressed');
        handleKeyClick(label, logical);
      });

      g.addEventListener('mouseup', () => {
        g.classList.remove('pressed');
      });

      g.addEventListener('mouseleave', () => {
        g.classList.remove('pressed');
      });
    });
  }

  function handleKeyClick(label, logical) {
    if (logical === undefined) {
      logical = logicalFromLabel(label);
    }

    if (!logical) {
      return;
    }

    // Sticky modifiers
    if (MODIFIER_KEYS.has(logical)) {
      toggleModifier(logical);
      return;
    }

    // CapsLock should always be immediate.
    if (logical === 'CapsLock') {
      sendKey(logical, []);
      return;
    }

    // If Enter is pressed and we have a completion, accept it.
    if (logical === 'Enter') {
      if (acceptSuggestionForCurrentWord()) {
        clearModifiers();
        return;
      }
    }

    const modifiers = Array.from(activeModifiers);
    sendKey(logical, modifiers);
    clearModifiers();

    // Autocomplete state update (best-effort; we don't read the real target app text).
    if (logical === 'Backspace') {
      currentWord = currentWord.slice(0, -1);
      updateSuggestions();
      return;
    }

    if (logical === 'Space' || logical === 'Tab' || logical === 'Enter') {
      currentWord = '';
      updateSuggestions();
      return;
    }

    if (typeof logical === 'string' && logical.length === 1 && /^[A-Z]$/.test(logical)) {
      currentWord += logical.toLowerCase();
      updateSuggestions();
      return;
    }

    // Any other key breaks the current word.
    if (typeof logical === 'string' && logical.length === 1) {
      currentWord = '';
      updateSuggestions();
    }
  }

  function toggleModifier(logical) {
    if (activeModifiers.has(logical)) {
      activeModifiers.delete(logical);
    } else {
      activeModifiers.add(logical);
    }
    updateModifierVisuals();
  }

  function clearModifiers() {
    activeModifiers.clear();
    updateModifierVisuals();
  }

  function updateModifierVisuals() {
    const allKeys = document.querySelectorAll('.kb-key');
    allKeys.forEach(g => {
      const l = g.dataset.logical;
      g.classList.toggle('latched', MODIFIER_KEYS.has(l) && activeModifiers.has(l));
    });
  }

  function attachSuggestionHandlers() {
    const buttons = document.querySelectorAll('#autocomplete-bar .suggestion');
    buttons.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        const word = (btn.textContent || '').trim();
        if (!word) return;

        selectedSuggestionIndex = index;
        renderSuggestions();

        const prefix = (currentWord || '').toLowerCase();
        if (prefix && word.toLowerCase().startsWith(prefix)) {
          sendText(word.slice(prefix.length) + ' ');
        } else {
          sendText(word + ' ');
        }

        currentWord = '';
        updateSuggestions();
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupKeyboard();
    attachSuggestionHandlers();
    updateSuggestions();
  });
</script>
</body>
</html>